name: Add Labels to Pull Requests

on:
  push:
    branches:
      - main
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  add-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install Dependencies
        run: npm install @actions/github octokit

      - name: Add Labels to Pull Requests
        run: |
          const { Octokit } = require("@octokit/rest");

          async function addLabelsToPullRequests() {
            const octokit = new Octokit({
              auth: process.env.GITHUB_TOKEN
            });

            const { owner, repo } = process.env.GITHUB_REPOSITORY;
            const { data: pullRequests } = await octokit.pulls.list({
              owner,
              repo
            });

            for (const pr of pullRequests) {
              const { number, body } = pr;

              // Extract issue numbers from pull request description
              const issueNumbers = body.match(/#(\d+)/g);
              if (!issueNumbers) continue;

              const labelsToAdd = [];

              // Get labels from each referenced issue
              for (const issueNumber of issueNumbers) {
                const issueId = parseInt(issueNumber.replace("#", ""), 10);

                const { data: issue } = await octokit.issues.get({
                  owner,
                  repo,
                  issue_number: issueId
                });

                // Add labels from the issue to the pull request
                if (issue.labels) {
                  labelsToAdd.push(...issue.labels.map(label => label.name));
                }
              }

              // Add labels to the pull request
              if (labelsToAdd.length > 0) {
                await octokit.issues.addLabels({
                  owner,
                  repo,
                  issue_number: number,
                  labels: labelsToAdd
                });
              }
            }
          }

          addLabelsToPullRequests().catch(error => {
            console.error("Error occurred:", error);
            process.exit(1);
          });
