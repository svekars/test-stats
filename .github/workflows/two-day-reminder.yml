name: Reminder to submit PR

on:
  schedule:
    - cron: "0 */12 * * *"

jobs:
  check-comments:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Comment Checker
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);

            async function getComments(issueNumber) {
              const response = await github.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              return response.data;
            }

            async function postComment(issueNumber, body) {
              await github.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }

            async function checkIssueComments() {
              const response = await github.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });

              const issues = response.data;
              for (const issue of issues) {
                const comments = await getComments(issue.number);
                const hasAssignMeComment = comments.some(comment => comment.body.includes("/assigntome"));
                const assignMeCommentDate = comments.find(comment => comment.body.includes("/assigntome"))?.created_at;

                if (hasAssignMeComment) {
                  const hasSubmitPRComment = comments.some(comment => comment.body.includes("Submit a PR"));

                  if (!hasSubmitPRComment) {
                    const commentDate = new Date(assignMeCommentDate);
                    if (commentDate < twoDaysAgo) {
                      const message = `@${issue.user.login} It's been more than 2 days since this issue was assigned. Please submit a PR ASAP.`;
                      await postComment(issue.number, message);
                    }
                  }
                }
              }
            }

            await checkIssueComments();
